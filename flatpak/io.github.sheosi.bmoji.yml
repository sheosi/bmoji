app-id: io.github.sheosi.bmoji
runtime: org.freedesktop.Platform
runtime-version: "25.08"
sdk: org.freedesktop.Sdk
sdk-extensions:
  - org.freedesktop.Sdk.Extension.rust-stable
command: bmoji

finish-args:
  - --share=ipc # Share IPC namespace with the host (necessary for X11).
  - --device=dri # OpenGL rendering support.
  - --socket=fallback-x11

  # Only needed if building with -tags wayland.
  - --socket=wayland

  - --device=dri

build-options:
  append-path: "/usr/lib/sdk/rust-stable/bin"

modules:
  - name: bmoji
    buildsystem: simple
    build-commands:
      # 1. Create the config file to point to the vendored crates
      - |
        mkdir -p .cargo
        cat <<EOF > .cargo/config.toml
        [source.crates-io]
        replace-with = "vendored-sources"

        [source.vendored-sources]
        directory = "vendor"
        EOF
      - cargo --offline fetch --manifest-path Cargo.toml --verbose
      - cargo --offline build --release --verbose
      - install -Dm00755 ./target/release/bmoji $FLATPAK_DEST/bin/bmoji
      - install -Dm00644 ./flatpak/Icon.png $FLATPAK_DEST/share/icons/hicolor/256x256/apps/$FLATPAK_ID.png
      - install -Dm00644 ./flatpak/$FLATPAK_ID.desktop $FLATPAK_DEST/share/applications/$FLATPAK_ID.desktop
      - install -Dm00644 ./flatpak/$FLATPAK_ID.appdata.xml $FLATPAK_DEST/share/appdata/$FLATPAK_ID.appdata.xml
    sources:
      - type: dir
        path: ../
    cleanup:
      - /target
      - /.cargo
